@model PostViewModel
@using System.Globalization
@{
var isAuthenticated = HttpContextAccessor.HttpContext.User.Identity.IsAuthenticated;

}

<div class="container">
    <div class="row">
        <!-- Post Details Section -->
        <div class="col-md-8">
            <div class="post-detail">
                <h2 class="text-center">@Model.Title</h2>
                <div class="post-image">
                    <img src="@Model.Image" alt="@Model.Title" class="img-fluid">
                </div>
                <div class="post-info mt-3">
                    <p><strong>Davet Adı:</strong> @Model.Title</p>
                    <p><strong>Açıklama:</strong> @Model.Description</p>

                    <div id="map" style="height: 400px; margin-bottom: 20px;"></div>
                    <p><strong>Tarih:</strong> @{
                        DateTime date;
                        string formattedDate = string.Empty;
                        if (DateTime.TryParse(Model.FormattedDate, out date))
                        {
                        formattedDate = date.ToString("dd MMMM yyyy", new CultureInfo("tr-TR"));
                        }
                        }
                        @formattedDate</p>
                    <p><strong>Zaman:</strong> @{
                        TimeSpan time;
                        string formattedTime = string.Empty;
                        if (TimeSpan.TryParse(Model.Time, out time))
                        {
                        formattedTime = time.ToString(@"hh\:mm");
                        }
                        }
                        @formattedTime</p>
                    <p><strong>Maksimum Katılımcı Sayısı:</strong> @Model.MaxParticipants</p>
                    <p><strong>Katılımcılar:</strong> @Model.Participants.Count / @Model.MaxParticipants</p>
                </div>
                <div class="text-center mt-4" id="content">

                    <button id="participateButton" class="btn-join">Katıl</button>
                    <div id="loginPrompt">
                        <p> Katılmak için lütfen giriş yapın.</p>
                        <button id="loginButton" class="btn-join">Giriş Yap</button>
                    </div>

                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="menu">
                <h4>Menü</h4>
                <ul class="list-group">
                    @foreach (var food in ViewBag.RelatedFoods)
                    {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@food.Title</strong>
                            <p>@food.Description</p>
                        </div>

                    </li>
                    }
                </ul>
            </div>
            <div class="participants">
                <h4>Katılımcılar</h4>
                <ul class="list-group">
                    <!--foreach (var participant in ViewBag.Participants)
                    {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>participant.Name</strong>
                            <p>articipant.Email</p>
                        </div>
                        
                    </li>
                    }-->
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Yasin</strong>

                        </div>

                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Comments Section -->
    <div class="comments-section mt-5">
        <h3>Yorumlar</h3>
        <ul id="comments-list" class="list-group mb-3">
            <!-- Yorumlar burada gösterilecek -->
        </ul>

        @if (isAuthenticated)
        {
        <div class="comment-input mb-3">
            <input type="text" id="comment-content" class="form-control" placeholder="Yorumunuzu yazın...">
            <button id="add-comment-btn" class="btn btn-primary mt-2">Yorum Ekle</button>
        </div>
        }
        else
        {
        <p>Lütfen yorum yapmak için <a href="@Url.Action(" Login", "Auth" )">giriş yapın</a>.</p>
        }
    </div>

</div>


<style>
    #loginPrompt {
        display: none;
        color: red;
        font-size: 18px;
        margin-top: 20px;
    }



    body {
        font-family: 'Arial', sans-serif;

        box-sizing: border-box;
    }

    .container {
        margin-top: 30px;
    }

    .post-detail {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        transition: all 0.3s ease-in-out;
    }

    .post-detail:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .post-detail h2 {
        font-size: 2em;
        margin-bottom: 20px;
        color: #343a40;
    }

    .post-image img {
        width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 20px;
        transition: transform 0.3s ease-in-out;
    }

    .post-image img:hover {
        transform: scale(1.05);
    }

    .post-info p {
        margin-bottom: 10px;
        font-size: 1.1em;
        color: #555;
    }

    .menu,
    .participants {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        max-height: 300px;
        /* Sabit yükseklik */
        overflow-y: auto;
        /* Dikey kaydırma */
    }

    .menu:hover,
    .participants:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .menu h4,
    .participants h4 {
        margin-bottom: 20px;
        font-size: 1.5em;
        color: #343a40;
    }

    .list-group-item {
        background: #f8f9fa;
        border: none;
        border-radius: 5px;
        margin-bottom: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.3s ease-in-out;
    }

    .list-group-item:hover {
        background: #e2e6ea;
    }

    .list-group-item div {
        max-width: 70%;
    }

    .img-thumbnail {
        border-radius: 5px;
        margin-left: 10px;
        max-width: 60px;
        transition: transform 0.3s ease-in-out;
    }

    .img-thumbnail:hover {
        transform: scale(1.1);
    }

    .btn-join {
        background-color: #28a745;
        color: #ffffff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background 0.3s ease-in-out;
    }

    .btn-join:hover {
        background-color: #218838;
    }

    .btn-disabled {
        background-color: grey;
        cursor: not-allowed;
    }

    .comments-section {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
    }

    .comments-section h3 {
        font-size: 1.8em;
        margin-bottom: 20px;
        color: #343a40;
        text-align: center;
    }

    #comments-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #comments-list .list-group-item {
        background: #f1f1f1;
        border: none;
        border-radius: 5px;
        margin-bottom: 10px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        transition: background 0.3s ease-in-out;
    }

    #comments-list .list-group-item:hover {
        background: #e0e0e0;
    }

    #comments-list .list-group-item strong {
        font-size: 1.1em;
        color: #007bff;
        margin-bottom: 5px;
        align-self: flex-start;
    }

    #comments-list .list-group-item small {
        color: #6c757d;
        text-align: right;
        align-self: flex-end;
    }

    .comment-input {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .comment-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .comment-input button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        transition: background 0.3s ease-in-out;
    }

    .comment-input button:hover {
        background-color: #0056b3;
    }
</style>
@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isAuthenticated = '@isAuthenticated' === 'True';
        const participateButton = document.getElementById('participateButton');
        const loginPrompt = document.getElementById('loginPrompt');
        const loginButton = document.getElementById('loginButton');
        // Yorumları yükle
        function loadComments() {
            fetch(`@Url.Action("GetCommentsByPostId","Comment")?postId=@Model.PostId`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const commentsList = document.getElementById('comments-list');
                        commentsList.innerHTML = '';
                        data.comments.forEach(comment => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            const formattedDate = new Date(comment.createdAt).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            listItem.innerHTML = `<div><strong>${comment.userName}:</strong> ${comment.content}</div> <small>${formattedDate}</small>`;
                            commentsList.appendChild(listItem);

                        });
                    } else {
                        alert('Yorumlar yüklenirken bir hata meydana geldi: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Yorumlar yüklenirken bir hata meydana geldi: ' + error.message);
                });
        }
        if (isAuthenticated) {
            var postId = '@Model.PostId';

            fetch(`@Url.Action("RequestStatus","Participant")?postId=${postId}`)
                .then(response => response.json())
                .then(data => {

                    var requestStatus = data.status;


                    if (requestStatus === -1) {
                        // İstek yapılmamış
                        participateButton.style.display = 'inline-block';
                        participateButton.disabled = false;
                        participateButton.textContent = 'Katıl';
                    } else if (requestStatus === 0) {
                        // İstek beklemede
                        participateButton.style.display = 'inline-block';
                        participateButton.disabled = true;
                        participateButton.textContent = 'İstek Beklemede';
                        participateButton.classList.add('btn-disabled');
                    } else if (requestStatus === 1) {
                        // İstek onaylanmış
                        participateButton.style.display = 'inline-block';
                        participateButton.disabled = true;
                        participateButton.textContent = 'İstek Onaylanmış';
                        participateButton.classList.add('btn-disabled');
                    } else if (requestStatus === 2) {
                        // İstek reddedilmiş
                        participateButton.style.display = 'inline-block';
                        participateButton.disabled = true;
                        participateButton.textContent = 'İstek Reddedilmiş';
                        participateButton.classList.add('btn-disabled');
                    }
                })
                .catch(error => console.error('Error:', error));
            participateButton.style.display = 'inline-block';
            loginPrompt.style.display = 'none';
            loginButton.style.display = 'none';
            document.getElementById('add-comment-btn').addEventListener('click', function () {
                const commentContent = document.getElementById('comment-content').value;
                const newComment = {
                    postId: '@Model.PostId',

                    content: commentContent
                };

                fetch('@Url.Action("AddComment","Comment")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newComment)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const commentsList = document.getElementById('comments-list');
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            const formattedDate = new Date(data.comment.createdAt).toLocaleString('tr-TR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            listItem.innerHTML = `<div><strong>${data.comment.userName}:</strong> ${data.comment.content}</div> <small>${formattedDate}</small>`;
                            commentsList.appendChild(listItem);
                            document.getElementById('comment-content').value = '';
                        } else {
                            alert('Yorum eklenirken bir hata meydana geldi: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Yorum eklenirken bir hata meydana geldi: ' + error.message);
                    });
            });

            loadComments();
        } else {
            loginPrompt.style.display = 'block';
            loginButton.style.display = 'inline-block';
            participateButton.style.display = 'none';
        }

        loginButton.addEventListener('click', function () {
            const currentUrl = window.location.href;
            window.location.href = '@Url.Action("Login", "Auth")' + '?returnUrl=' + encodeURIComponent(currentUrl);
        });

        participateButton.addEventListener('click', function () {


            fetch('@Url.Action("Join","Participant", new { postId = Model.PostId })', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        NProgress.done();
                        Swal.fire({
                            title: 'Katılma isteği başarıyla gönderildi!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        })
                        location.reload();
                    } else {
                        NProgress.done();
                        Swal.fire({
                            title: 'Error!',
                            text: data.message || "An error occurred.",
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    NProgress.done();
                    console.error('Error:', error);
                    alert('Bir hata oluştu, lütfen daha sonra tekrar deneyiniz.');
                });
        });
    });
</script>
<script>
    function initMap() {
        // Razor ile elde edilen Latitude ve Longitude değerlerini JavaScript değişkenlerine atayın
        var latitude = parseFloat('@Model.Latitude');
        var longitude = parseFloat('@Model.Longitude');

        var map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: latitude, lng: longitude },
            zoom: 12
        });

        var marker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude },
            map: map
        });
    }

    // Google Maps API yüklemesi
    function loadGoogleMaps() {
        var script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyB8fnr_8wb9KuVpwj1b1hhtJGCMpQ9td5k&callback=initMap`;
        script.defer = true;
        document.head.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadGoogleMaps();
    });

</script>
}